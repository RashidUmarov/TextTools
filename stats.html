<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>HTML Stats</title>
    <!-- Общие стили сайта -->
    <link rel="stylesheet" href="styles.css">
    <!-- Специфичные стили для страницы статистики -->
    <link rel="stylesheet" href="stats.css">
</head>
<body>
  <div class="header">
    <div class="inner-header">
      <div class="logo-container">
        <h1>HTML Stats</h1>
      </div>
      <nav class="navigation">
      <ul>
        <li><a href="stats.html">Stats</a></li>
        <li><a href="sizer.html">Sizer</a></li>
        <li><a href="link_dropper.html">Dropper</a></li>
        <li><a href="code_blocks.html">Blocks</a></li>
        <li><a href="changer.html">Changer</a></li>
        <li><a href="composer.html">Composer</a></li>
        <li><a href="cleaner.html">Cleaner</a></li>
        <li><a href="index.html">About</a></li>
      </ul>
      </nav>
    </div>
  </div>

  <div class="content">
    <div id="drop_zone">Перетащите сюда файл</div>
    <div id="file_contents">Здесь появится содержимое файла…</div>
    <div id="link_blocks"></div>
    <!-- Блок для статистики кириллицы -->
    <div id="cyrillic_stats" style="margin-top: 1em;
                                       padding: 0.5em;
                                       border: 1px solid #ccc; display:none;
                                       "></div>
    <button id="reset_button" class="btn-look">Сбросить</button>
  </div>

  <script>
    const dropZone = document.getElementById('drop_zone');
    const output = document.getElementById('file_contents');
    const resetButton = document.getElementById('reset_button');
    const linkBlocks = document.getElementById('link_blocks');
    const statsBlock = document.getElementById('cyrillic_stats');

    // Поведение drag & drop
    ['dragenter','dragover','dragleave','drop'].forEach(evt => {
      dropZone.addEventListener(evt, e => e.preventDefault());
      document.body.addEventListener(evt, e => e.preventDefault());
    });

    dropZone.addEventListener('dragover', () => {
      dropZone.classList.add('hover');
      dropZone.textContent = 'Отпустите файл';
    });
    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('hover');
      dropZone.textContent = 'Перетащите сюда файл';
    });

    // Функция подсчёта слов и символов на кириллице, исключая блок #announce
    function calculateCyrillicStats(html) {
      const doc = new DOMParser().parseFromString(html, 'text/html');
      // Удаляем блок анонса, если он есть
      const announceEl = doc.getElementById('announce');
      if (announceEl) announceEl.remove();
      // Берём текст всего тела документа без #announce
      const text = doc.body.textContent || '';
      // Ищем слова только из кириллицы
      const matches = text.match(/[А-ЯЁа-яё]+/g) || [];
      const wordsCount = matches.length;
      const charsCount = matches.reduce((sum, w) => sum + w.length, 0);
      return { wordsCount, charsCount };
    }

    dropZone.addEventListener('drop', e => {
      dropZone.classList.remove('hover');
      dropZone.textContent = 'Файл получен!';
      const file = e.dataTransfer.files[0];
      if (!file || !file.type.match('text.*')) {
        output.textContent = 'Пожалуйста, перетащите текстовый файл.';
        return;
      }
      const reader = new FileReader();
      reader.onload = ev => {
        const html = ev.target.result;
        const { title, description, announce } = extractArticleInfo(html);
        const links = extractCategoryLinks(html);

        // Вывод заголовка, описания и анонса
        output.innerHTML =
          `<h2>${title}</h2>` +
          `<div class="styled-block"><p>${description}</p></div>` +
          `<div>${announce}</div>`;

        // Отрисовка блоков ссылок
        renderCategoryBlocks('link_blocks', links);

        // Подсчёт и вывод статистики кириллицы, без #announce
        const stats = calculateCyrillicStats(html);
        statsBlock.style.display = 'block';
        statsBlock.innerHTML = `
          <h3>Статистика кириллических слов</h3>
          <p>Количество слов: ${stats.wordsCount}</p>
          <p>Количество символов: ${stats.charsCount}</p>
        `;

        resetButton.style.display = 'block';
      };
      reader.onerror = () => {
        output.textContent = 'Ошибка при чтении файла.';
      };
      reader.readAsText(file, 'UTF-8');
    });

    resetButton.addEventListener('click', () => {
      output.textContent = 'Здесь появится содержимое файла…';
      dropZone.textContent = 'Перетащите сюда файл';
      resetButton.style.display = 'none';
      linkBlocks.innerHTML = '';
      statsBlock.style.display = 'none';
    });

    function extractArticleInfo(html) {
      const doc = new DOMParser().parseFromString(html, 'text/html');
      return {
        title: doc.querySelector('title')?.textContent.trim() || 'Нет заголовка',
        description: doc.querySelector('#description')?.textContent.trim() || 'Нет описания',
        announce: doc.querySelector('#announce')?.innerHTML.trim() || 'Нет анонса'
      };
    }

    function extractCategoryLinks(html) {
      const doc = new DOMParser().parseFromString(html, 'text/html');
      const anchors = Array.from(doc.querySelectorAll('a[href]'));
      const categories = { articles: [], code: [], docs: [], metatrader5: [] };
      anchors.forEach(a => {
        const href = a.getAttribute('href');
        if (/\/articles\//.test(href)) categories.articles.push(href);
        else if (/\.mql5\.com\/.*\/code/.test(href)) categories.code.push(href);
        else if (/\/docs\//.test(href)) categories.docs.push(href);
        else if (/metaquotes\.net/.test(href)) categories.metatrader5.push(href);
        else if (/metatrader5\.com/.test(href)) categories.metatrader5.push(href);
      });
      return categories;
    }

    function renderCategoryBlocks(containerId, categories) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      Object.entries(categories).forEach(([key, links]) => {
        const block = document.createElement('div');
        block.className = 'styled-block';
        const title = document.createElement('h3');
        title.textContent = `${key.charAt(0).toUpperCase() + key.slice(1)} (${links.length})`;
        const list = document.createElement('ul');
        links.forEach(link => {
          const li = document.createElement('li');
          const a = document.createElement('a');
          a.href = link;
          a.textContent = link;
          a.target = '_blank';
          li.appendChild(a);
          list.appendChild(li);
        });
        block.append(title, list);
        container.appendChild(block);
      });
    }
  </script>
</body>
</html>
